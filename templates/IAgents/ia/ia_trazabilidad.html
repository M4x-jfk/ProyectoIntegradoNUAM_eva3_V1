{% extends 'IAgents/ia/base_ia.html' %}

{% block title %}Trazabilidad End-to-End - NUAM IA{% endblock %}

{% block content %}
<h1 class="mb-4">Trazabilidad del Dato (IA → ETL → BD)</h1>

<div class="card mb-4">
    <div class="card-body">
        <form class="form-inline" style="display: flex; gap: 10px; align-items: center;">
            <label>Buscar por ID Archivo Fuente:</label>
            <input type="text" class="form-control" placeholder="Ej: 1024">
            <button type="submit" class="btn btn-primary">Rastrear</button>
        </form>
    </div>
</div>

<div class="trace-container">
    <!-- Paso 1: Archivo Fuente -->
    <div class="trace-step">
        <h3>1. Archivo Fuente</h3>
        {% if archivo_fuente %}
        <p><strong>ID:</strong> {{ archivo_fuente.id_archivo_fuente }}</p>
        <p><strong>Nombre:</strong> {{ archivo_fuente.nombre_original }}</p>
        <p><strong>Subido:</strong> {{ archivo_fuente.fecha_subida|date:"d/m/Y H:i" }}</p>
        <p><strong>Estado:</strong> <span class="badge estado-{{ archivo_fuente.estado_proceso|slugify }}">{{
                archivo_fuente.estado_proceso }}</span></p>
        <div class="text-center mt-2">
            <a href="{% url 'ia_archivos_fuente_detail' archivo_fuente.id_archivo_fuente %}"
                class="btn btn-sm btn-outline-secondary">Ver Detalle</a>
        </div>
        {% else %}
        <p class="text-muted text-center py-4">Seleccione un rastro...</p>
        {% endif %}
        <div style="position: absolute; right: -12px; top: 50%; transform: translateY(-50%); z-index: 1; color: #ccc;">
            ▶
        </div>
    </div>

    <!-- Paso 2: Tareas IA & Normalización -->
    <div class="trace-step">
        <h3>2. Procesamiento IA</h3>
        {% if tarea_ia %}
        <p><strong>Tarea ID:</strong> {{ tarea_ia.id_tarea_ia }}</p>
        <p><strong>Modelo:</strong> {{ tarea_ia.modelo_utilizado }}</p>
        <p><strong>Estructuras:</strong> {{ estructuras_count }} detectadas</p>
        <hr>
        <p><strong>Archivo Norm.:</strong> #{{ archivo_normalizado.id_archivo_normalizado }}</p>
        <p><strong>Estado Val.:</strong> <span
                class="badge estado-{{ archivo_normalizado.estado_validacion|slugify }}">{{
                archivo_normalizado.estado_validacion }}</span></p>
        {% else %}
        <p class="text-muted text-center py-4">Esperando datos...</p>
        {% endif %}
        <div style="position: absolute; right: -12px; top: 50%; transform: translateY(-50%); z-index: 1; color: #ccc;">
            ▶
        </div>
    </div>

    <!-- Paso 3: Carga Masiva -->
    <div class="trace-step">
        <h3>3. Carga Masiva</h3>
        {% if carga_masiva %}
        <p><strong>Carga ID:</strong> {{ carga_masiva.id_carga }}</p>
        <p><strong>Fecha:</strong> {{ carga_masiva.fecha_inicio|date:"d/m/Y" }}</p>
        <p><strong>Total Filas:</strong> {{ carga_masiva.total_filas }}</p>
        <p><strong>Filas OK:</strong> <span class="text-success">{{ carga_masiva.filas_ok }}</span></p>
        <p><strong>Filas Error:</strong> <span class="text-danger">{{ carga_masiva.filas_error }}</span></p>
        <div class="text-center mt-2">
            <a href="{% url 'ia_carga_masiva_resumen' carga_masiva.id_carga %}"
                class="btn btn-sm btn-outline-secondary">Ver Reporte</a>
        </div>
        {% else %}
        <p class="text-muted text-center py-4">Esperando datos...</p>
        {% endif %}
        <div style="position: absolute; right: -12px; top: 50%; transform: translateY(-50%); z-index: 1; color: #ccc;">
            ▶
        </div>
    </div>

    <!-- Paso 4: Impacto en BD -->
    <div class="trace-step">
        <h3>4. Base de Datos</h3>
        {% if calificaciones_afectadas %}
        <p><strong>Registros Impactados:</strong> {{ calificaciones_afectadas|length }}</p>
        <ul style="padding-left: 20px; font-size: 0.9em;">
            {% for cal in calificaciones_afectadas|slice:":5" %}
            <li>Calificación ID #{{ cal.id }} ({{ cal.estado }})</li>
            {% endfor %}
            {% if calificaciones_afectadas|length > 5 %}
            <li>... y {{ calificaciones_afectadas|length|add:"-5" }} más</li>
            {% endif %}
        </ul>
        {% else %}
        <p class="text-muted text-center py-4">Esperando datos...</p>
        {% endif %}
    </div>
</div>
{% endblock %}